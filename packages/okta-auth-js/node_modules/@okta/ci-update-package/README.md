CI-UPDATE-PACKAGE
=======

Updates package.json version and adds additional okta metadata.

This module should be installed in all internal NPM modules that integrate with Bacon - it is one of the scripts that needs to be run prior to publishing an NPM module.


## Using ci-update-package

### Setup

In your module's root app folder, run:
```bash
# Install latest version
[npm/my-module]$ npm install @okta/ci-update-package --save-dev
```

Now, update your package.json file with a new ci-update-package run script:
```javascript
// package.json
"scripts": {
  "ci-update-package": "ci-update-package"
}
```

### Usage

**NOTE:** This should only be run in CI or when developing this package.

```bash
# Finds properties and updates package.json
[npm/my-module]$ npm run ci-update-package -- --branch <branchName>

# Dry-run - does not write to package.json
[npm/my-module]$ npm run ci-update-package -- --branch <branchName> --dry-run
```

## Developing ci-update-package

### Setup

```bash
# Clone the npm repo if you haven't done so already
[okta]$ git clone git@github.com:okta/npm.git

# Navigate to the ci-update-package dir
[okta]$ cd npm/ci-update-package
```

### Dev commands

| Command      | Description
| ------------ | -----------
| npm test     | Run mocha unit tests
| npm run lint | Run eslint

### Bacon

To commit, get the :rocket: and merge through the [ci-update-package bacon board](http://bacon.trex.saasure.com/#!/commits/ci-update-package).

## Updated package.json properties

#### 1. package.version

Updates existing `package.version` according to [semver rules](https://github.com/npm/node-semver) and [our versioning strategy](https://oktawiki.atlassian.net/wiki/display/eng/CI+NPM%3A+Design+flow+for+standardizing+versioning+and+CI+of+NPM+artifacts#CINPM:DesignflowforstandardizingversioningandCIofNPMartifacts-Solution:OneNPMregistry.Oneversionperchange.).

To prevent publishing to the same version when multiple developers are working on the same module, this task fetches the latest published versions in the prerelease line and chooses the next available one.

| Branch      | Version line
| ----------  | -------------
| **master**  | *beta* prerelease for the next minor version , i.e. 1.1.0-beta.2
| **topic**   | *alpha* prerelease for the next minor version, i.e. 2.1.0-alpha.1
| **release** | next minor release version

An example commit flow would look like this:

**Initial state: package.json version is 1.0.0, no published versions**

| Event                               | Published version | type
| ----------------------------------- | ----------------- | ----
| Jackson pushes topic branch         | 1.1.0-alpha.0     | prerelease
| Debbie pushes topic branch          | 1.1.0-alpha.1     | prerelease
| Debbie merges her topic branch      | 1.1.0-beta.0      | prerelease
| Jackson merges his topic branch     | 1.1.0-beta.1      | prerelease
| Jackson promotes the master branch  | 1.2.0             | release

#### 2. package.okta

Adds a new `package.okta` property which holds useful information about the commit:

| Property         | Description |
| ---------------- | ----------- |
| okta.fullVersion | Metadata used to tag artifact in artifactory |
| okta.commitSha   | Full git commit SHA |
| okta.testedSha   | Full git SHA for the tested topic SHA that generates a master commit. **NOTE:** this only exists for beta prereleases. |
